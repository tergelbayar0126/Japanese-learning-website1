<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Japanese Learning Platform</title>

<!-- Main app styling -->
<link rel="stylesheet" href="style.css">

<style>
/* =============================
   BASE LAYOUT
============================= */
:root{
  --navbar-height: 68px;
  --header-height: 140px;
  --icon-color: #000000;
  --icon-accent: #c8604d;
  --icon-bg: linear-gradient(180deg, rgba(242,237,228,0.95), rgba(235,228,215,0.92));
  --icon-color-hover: color-mix(in srgb, var(--icon-color) 80%, white 20%);
  --icon-accent-hover: color-mix(in srgb, var(--icon-accent) 75%, white 25%);
  
  /* Traditional Japanese folktale palette */
  --accent-1: #4a4035; /* Sumi ink brown */
  --accent-2: #2f4858; /* Deep indigo blue */
  --accent-3: #8b6f47; /* Bamboo */
  --accent-4: #4a5d4f; /* Pine green */
  --accent-5: #c8604d; /* Persimmon red */
  --accent-6: #7d6b5e; /* Clay earth */
  --accent-7: #3d4a3c;
  --accent-8: #d4a574; /* Golden wheat */
  --muted-1: #f2ede4;
  --bg-gradient: linear-gradient(135deg, #f2ede4 0%, #ebe4d7 100%);
  
  /* Texture overlays */
  --washi-texture: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="noise"><feTurbulence baseFrequency="0.9" numOctaves="4" /></filter><rect width="200" height="200" filter="url(%23noise)" opacity="0.03"/></svg>');
}
* {
    box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  background: 
    radial-gradient(ellipse at 20% 10%, rgba(200, 96, 77, 0.08) 0%, transparent 40%),
    radial-gradient(ellipse at 80% 90%, rgba(47, 72, 88, 0.08) 0%, transparent 40%),
    linear-gradient(180deg, #f2ede4 0%, #ebe4d7 50%, #e8dfd0 100%),
    var(--washi-texture);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
  line-height: 1.6;
  overflow-x: hidden;
}

body.dark-mode {
    background: linear-gradient(135deg, #141418 0%, #1a1a25 100%);
    color: #000000;
}

h1, h2 {
    color: #000000;
    text-align: center;
    margin: 16px 0;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-shadow: 
      0 1px 0 rgba(255, 255, 255, 0.8),
      0 2px 3px rgba(74, 64, 53, 0.15);
}

h1 {
    font-size: 2.5rem;
    color: #000000;
}

h2 {
    font-size: 1.8rem;
    color: #000000;
}

/* =============================
   APP WRAPPER
============================= */
#app {
    position: relative;
    min-height: 100vh;
    overflow-x: hidden;
    z-index: 1;
}

#floatingCanvas {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 0;
  opacity: 0.04;
  will-change: contents;
  transform: translateZ(0);
  backface-visibility: hidden;
}

#animationToggleBtn { margin-left: 10px; }

/* =============================
   SITE CONTENT
============================= */
.site-content {
    position: relative;
    z-index: 1;
    padding-bottom: 80px;
  padding-top: calc(var(--header-height) + 16px);
    max-width: 1400px;
    margin: 0 auto;
    transform: translateZ(0);
}

/* Removed site-content::before to allow petals to be visible */

.site-content > * {
  position: relative;
  z-index: 1;
}

.site-content, .site-content p, .site-content li {
  color: #000000;
  text-shadow: 0 1px 0 rgba(255,255,255,0.6);
}

/* Removed dark mode site-content::before to allow petals to be visible */

body.dark-mode .site-content, body.dark-mode .site-content p, body.dark-mode .site-content li {
  color: #000000;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* =============================
   HEADER
============================= */
header {
  background: 
    linear-gradient(180deg, 
      rgba(242, 237, 228, 0.98) 0%, 
      rgba(235, 228, 215, 0.95) 100%),
    var(--washi-texture);
  padding: 16px 20px 12px 20px;
  box-shadow: 
    0 2px 0 rgba(61, 40, 24, 0.6),
    0 6px 20px rgba(74, 64, 53, 0.2);
  border-bottom: 4px solid #3d2818;
  border-top: 1px solid rgba(61, 40, 24, 0.2);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--header-height);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  z-index: 1000;
  will-change: box-shadow;
  contain: layout style;
  transform: translateZ(0);
  backface-visibility: hidden;
  perspective: 1000px;
}

header.scrolled {
  box-shadow: 0 6px 30px rgba(0,0,0,0.12);
}

header h1 {
    margin: 0 0 4px 0;
    animation: fadeInDown 0.6s ease;
}

header p {
    text-align: center;
    color: #000000;
    font-size: 1rem;
    margin: 0 0 8px 0;
    font-weight: 500;
}

@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* =============================
   NAVBAR
============================= */
.navbar {
    display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 8px;
  padding: 0;
  background: transparent;
  backdrop-filter: none;
  box-shadow: none;
  position: static; /* inside header */
  z-index: auto;
  height: auto;
  width: 100%;
}

.nav-btn {
  background: linear-gradient(135deg, #4a4035, #2f4858);
  color: #000000;
  padding: 10px 20px;
  border-radius: 25px;
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 1px 0 rgba(200, 96, 77, 0.2),
    0 4px 12px rgba(74, 64, 53, 0.25);
  border: 2px solid #3d2818;
  position: relative;
  overflow: hidden;
}

.nav-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(200, 96, 77, 0.3), transparent);
  transition: left 0.4s ease;
}

.nav-btn:hover::before {
  left: 100%;
}

.nav-btn:hover {
  background: linear-gradient(135deg, #c8604d, #d4a574);
  color: #000000;
  box-shadow: 
    0 2px 0 rgba(200, 96, 77, 0.4),
    0 6px 16px rgba(200, 96, 77, 0.35);
  border: 2px solid #3d2818;
  transform: translateY(-1px);
}

.nav-btn:active {
    box-shadow: 0 2px 8px rgba(255, 77, 148, 0.3);
}

/* =============================
   MENU
============================= */
.page {
    padding: 40px 20px;
    animation: fadeIn 0.5s ease;
    min-height: 60vh;
    max-width: 1400px;
    margin: 0 auto;
}

.menu-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 22px;
  max-width: 1000px;
  margin: 28px auto 40px auto;
  padding: 0 18px;
  justify-items: center;
  align-items: stretch;
}

/* Home hero background panel so cards can overlap it visually */
.home-hero { position: relative; max-width: 1100px; margin: 10px auto 40px auto; }
.home-hero-bg {
  position: absolute;
  inset: 0;
  top: 18px;
  left: 6px;
  right: 6px;
  bottom: -6px;
  border-radius: 20px;
  background: linear-gradient(180deg, rgba(244,242,237,0.25), rgba(237,232,224,0.15));
  box-shadow: 0 20px 60px rgba(93,78,109,0.06);
  border: 2px solid rgba(61, 40, 24, 0.15);
  z-index: 1;
  pointer-events: none;
}

.home-hero .menu-grid { position: relative; z-index: 2; margin-top: -36px; gap: 28px; }
.home-hero .menu-button { transform-origin: center top; z-index: 3; }

.menu-button {
  background: 
    linear-gradient(180deg, 
      rgba(242, 237, 228, 0.95) 0%, 
      rgba(235, 228, 215, 0.9) 100%),
    var(--washi-texture);
  border-radius: 12px;
  padding: 24px 18px;
  box-shadow: 
    0 1px 0 rgba(200, 96, 77, 0.15),
    0 6px 20px rgba(74, 64, 53, 0.18),
    inset 0 1px 0 rgba(255, 255, 255, 0.5);
  text-decoration: none;
  color: #000000;
  width: 100%;
  max-width: 320px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 140px;
  transition: transform 260ms ease, box-shadow 260ms ease, border-color 260ms ease;
  border: 3px solid #3d2818;
  position: relative;
  overflow: hidden;
}

.menu-grid .menu-button {
  opacity: 0;
  transform: translateY(12px) scale(0.995);
  animation: fadeUp 420ms ease forwards;
}
.menu-grid .menu-button:nth-child(1){ animation-delay: 80ms; }
.menu-grid .menu-button:nth-child(2){ animation-delay: 160ms; }
.menu-grid .menu-button:nth-child(3){ animation-delay: 240ms; }
.menu-grid .menu-button:nth-child(4){ animation-delay: 320ms; }
.menu-grid .menu-button:nth-child(5){ animation-delay: 400ms; }

@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.menu-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(139, 111, 71, 0.2), transparent);
    transition: left 0.5s;
}

.menu-button:hover::before {
    left: 100%;
}

.menu-button:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 2px 0 rgba(200, 96, 77, 0.4),
    0 10px 28px rgba(74, 64, 53, 0.25),
    inset 0 1px 0 rgba(255, 255, 255, 0.6);
  border: 3px solid #3d2818;
  border-bottom-color: #000000;
  border-right-color: #000000;
  background: 
    linear-gradient(180deg, 
      rgba(242, 237, 228, 1) 0%, 
      rgba(235, 228, 215, 0.98) 100%),
    var(--washi-texture);
}

.home-hero { overflow: visible; }

.menu-icon {
  width: 64px;
  height: 64px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  background: var(--icon-bg);
  box-shadow: 0 6px 18px rgba(93, 78, 109, 0.15);
  border: 2px solid rgba(93, 78, 109, 0.25);
  transition: box-shadow 260ms ease, border-color 260ms ease;
}

@keyframes subtleFloat { 0%, 100% { transform: translateY(0);} 50% { transform: translateY(-2px);} }

.menu-icon svg { width: 36px; height: 36px; display:block; }
.menu-icon svg [data-fill="primary"] { fill: var(--icon-color); transition: fill 180ms ease; }
.menu-icon svg [data-fill="accent"] { fill: var(--icon-accent); transition: fill 180ms ease; }

.menu-button:hover .menu-icon svg [data-fill="primary"] { fill: var(--icon-color-hover); }
.menu-button:hover .menu-icon svg [data-fill="accent"] { fill: var(--icon-accent-hover); }
.menu-button:hover .menu-icon svg { transform-origin: center center; transition: transform 180ms ease; }

@keyframes iconPulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.03); opacity: 0.95; }
  100% { transform: scale(1); opacity: 1; }
}

.menu-title { transition: color 220ms ease; }
.menu-button:hover .menu-title { color: var(--icon-color); }

.menu-desc { transition: opacity 260ms ease; }
.menu-button:hover .menu-desc { opacity: 1; }

#animSvg line { stroke-linecap: round; stroke-width: 8; stroke: #5d4e6d; fill: none; }
#animSvg line.animate-draw {
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  transition: stroke-dashoffset 360ms ease, opacity 260ms ease;
}

.menu-title {
  font-weight: 800;
  margin: 8px 0 6px 0;
  font-size: 1.05rem;
  color: #000000;
  letter-spacing: -0.2px;
}

.menu-desc {
  font-size: 13px;
  opacity: 0.85;
  color: #000000;
  line-height: 1.35;
  text-align: center;
  max-width: 90%;
}

@media (min-width: 600px) {
  .menu-grid { grid-template-columns: repeat(2, 1fr); max-width: 900px; }
}

@media (min-width: 1000px) {
  .menu-grid { grid-template-columns: repeat(3, 1fr); max-width: 1200px; }
}

.menu-button:nth-child(1) {
  border-left: 4px solid var(--accent-1);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-1) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(1):hover {
  box-shadow: 0 14px 36px rgba(93, 78, 109, 0.2);
  border-color: var(--accent-1);
}

.menu-button:nth-child(2) {
  border-left: 4px solid var(--accent-2);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-2) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(2):hover {
  box-shadow: 0 14px 36px rgba(44, 95, 93, 0.2);
  border-color: var(--accent-2);
}

.menu-button:nth-child(3) {
  border-left: 4px solid var(--accent-3);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-3) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(3):hover {
  box-shadow: 0 14px 36px rgba(139, 111, 71, 0.2);
  border-color: var(--accent-3);
}

.menu-button:nth-child(4) {
  border-left: 4px solid var(--accent-4);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-4) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(4):hover {
  box-shadow: 0 14px 36px rgba(90, 124, 91, 0.2);
  border-color: var(--accent-4);
}

.menu-button:nth-child(5) {
  border-left: 4px solid var(--accent-5);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-5) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(5):hover {
  box-shadow: 0 14px 36px rgba(74, 93, 108, 0.2);
  border-color: var(--accent-5);
}

.menu-button:nth-child(6) {
  border-left: 4px solid var(--accent-6);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-6) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(6):hover {
  box-shadow: 0 14px 36px rgba(125, 107, 94, 0.2);
  border-color: var(--accent-6);
}

.menu-button:nth-child(7) {
  border-left: 4px solid var(--accent-7);
  background: linear-gradient(135deg, color-mix(in srgb, var(--accent-7) 10%, white) 0%, rgba(250,249,245,0.95) 100%);
}
.menu-button:nth-child(7):hover {
  box-shadow: 0 14px 36px rgba(61, 90, 108, 0.2);
  border-color: var(--accent-7);
}


.menu-button:focus {
  outline: none;
  box-shadow: 0 0 0 4px rgba(255,77,148,0.08);
}

/* =============================
   QUIZ OPTIONS & TOGGLE
============================= */
.curriculum-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 18px;
  margin: 20px auto 32px auto;
  max-width: 1100px;
}

.curriculum-card {
  background: linear-gradient(180deg, rgba(244,242,237,0.95), rgba(250,249,245,0.9));
  border: 2px solid rgba(93,78,109,0.2);
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 8px 20px rgba(93,78,109,0.12);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.curriculum-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.curriculum-primary {
  background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
  color: #000000;
  border: none;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(93,78,109,0.22);
}

.curriculum-card:hover {
  box-shadow: 0 14px 30px rgba(93,78,109,0.16);
}

.curriculum-card h3 {
  margin: 0;
  color: #000000;
  letter-spacing: -0.2px;
}

.curriculum-meta {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  font-size: 13px;
  color: #000000;
}

.curriculum-badge {
  background: rgba(93,78,109,0.08);
  color: #000000;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 600;
}

.curriculum-badge.level {
  background: rgba(44,95,93,0.12);
  color: #000000;
}

.curriculum-badge.time {
  background: rgba(139,111,71,0.12);
  color: #000000;
}

.curriculum-desc { color: #000000; font-size: 14px; line-height: 1.45; }

.curriculum-progress {
  background: rgba(93,78,109,0.08);
  border-radius: 10px;
  overflow: hidden;
  height: 12px;
  position: relative;
}

.curriculum-progress span {
  display: block;
  height: 100%;
  background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
  width: 0;
  transition: width 200ms ease;
}

.curriculum-progress-label {
  font-size: 12px;
  color: #000000;
  display: flex;
  justify-content: space-between;
}

.curriculum-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.curriculum-actions button {
  background: linear-gradient(135deg, var(--accent-2), var(--accent-1));
  border: none;
  color: #000000;
  padding: 8px 12px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(93,78,109,0.18);
}

.curriculum-actions button.secondary {
  background: #fff;
  color: #000000;
  border: 1px solid rgba(93,78,109,0.25);
}

.flash-lesson-banner {
  background: linear-gradient(135deg, rgba(93,78,109,0.12), rgba(139,111,71,0.12));
  border: 1px solid rgba(93,78,109,0.25);
  color: #000000;
  padding: 10px 12px;
  border-radius: 10px;
  margin: 8px 0 12px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
}

.flash-lesson-banner button {
  background: transparent;
  border: 1px solid rgba(93,78,109,0.35);
  color: #000000;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

body.dark-mode .flash-lesson-banner { background: rgba(93,78,109,0.15); border-color: #000000; color: #000000; }
body.dark-mode .flash-lesson-banner button { border-color: #000000; color: #000000; }

.curriculum-vocab {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  font-size: 13px;
  color: #000000;
}

.curriculum-vocab .chip {
  padding: 5px 10px;
  border-radius: 10px;
  background: rgba(93,78,109,0.1);
  border: 1px solid rgba(93,78,109,0.15);
}

.curriculum-sentences {
  font-size: 13px;
  color: #000000;
  line-height: 1.5;
}

.curriculum-sentences div { margin-top: 4px; }

.curriculum-badge.status {
  background: rgba(44,95,93,0.1);
  color: #000000;
}

body.dark-mode .curriculum-vocab .chip { background: rgba(139,111,71,0.2); border-color: #000000; color: #000000; }
body.dark-mode .curriculum-sentences { color: #000000; }
body.dark-mode .curriculum-badge.status { background: rgba(44,95,93,0.2); color: #000000; }

body.dark-mode .curriculum-card { background: #1f1f28; border-color: #000000; }
body.dark-mode .curriculum-desc { color: #000000; }
body.dark-mode .curriculum-badge { background: rgba(139,111,71,0.2); color: #000000; }
body.dark-mode .curriculum-progress { background: rgba(139,111,71,0.2); }
body.dark-mode .curriculum-progress-label { color: #000000; }

.quiz-options {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
    align-items: center;
    margin-bottom: 16px;
}

.kana-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
}

.toggle-label {
    font-weight: bold;
    color: #000000;
}

.toggle-btn {
    background: linear-gradient(135deg, #fff 0%, #f4f2ed 100%);
    border: 2px solid rgba(93,78,109,0.4);
    box-shadow: 0 2px 6px rgba(93, 78, 109, 0.12);
    color: #000000;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 6px rgba(93, 78, 109, 0.08);
}

.toggle-btn:hover {
    background: linear-gradient(135deg, #f9f8f4 0%, #ede9e0 100%);
    border-color: var(--accent-1);
    box-shadow: 0 4px 10px rgba(93, 78, 109, 0.15);
}

.toggle-btn.active {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: #000000;
    border-color: var(--accent-1);
    box-shadow: 0 4px 12px rgba(93, 78, 109, 0.3);
    transform: scale(1.03);
}

body.dark-mode .toggle-btn {
    background: #2a2a35;
    border-color: var(--accent-1);
    color: #000000;
}

body.dark-mode .toggle-btn.active {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    color: #000000;
}

body.dark-mode {
  --icon-color: #000000;
  --icon-accent: #d4a962;
  --icon-bg: linear-gradient(180deg, rgba(30,28,25,0.28), rgba(24,22,20,0.28));
}

/* =============================
   SECTION ENHANCEMENTS
============================= */
.page h2 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 2rem;
    background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
}

.control-section {
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(93, 78, 109, 0.15);
    margin: 20px auto;
    max-width: 600px;
    transition: box-shadow 0.3s ease, transform 0.3s ease, border-color 0.3s ease;
    border: 3px solid rgba(93, 78, 109, 0.3);
}

.control-section:hover {
    box-shadow: 0 6px 24px rgba(93, 78, 109, 0.2);
    border-color: #000000;
}

body.dark-mode .control-section {
    background: #2a2a35;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.control-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #000000;
}

.control-section select,
.control-section input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid rgba(93, 78, 109, 0.4);
    border-radius: 12px;
    font-size: 16px;
    box-shadow: 0 2px 4px rgba(93, 78, 109, 0.08);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background: white;
}

.control-section select:focus,
.control-section input:focus {
    outline: none;
    border-color: #000000;
    box-shadow: 0 0 0 3px rgba(93, 78, 109, 0.15);
}

body.dark-mode .control-section select,
body.dark-mode .control-section input {
    background: #1a1a24;
    border-color: #000000;
    color: #000000;
}

.stat-box {
    background: linear-gradient(135deg, #faf9f5, #f4f2ed);
    padding: 15px 20px;
    border-radius: 12px;
    text-align: center;
    min-width: 140px;
    border: 2px solid rgba(93, 78, 109, 0.3);
}

body.dark-mode .stat-box {
    background: linear-gradient(135deg, #1a1a24, #2a2a35);
    border-color: #000000;
}

.stat-label {
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 24px;
    font-weight: 800;
    color: #000000;
}

body.dark-mode .stat-value {
    color: #000000;
}

.char-display {
    font-size: 80px;
    font-weight: bold;
    text-align: center;
    margin: 20px 0;
    color: #000000;
    text-shadow: 0 2px 8px rgba(93, 78, 109, 0.3);
}

body.dark-mode .char-display {
    color: #000000;
}

.char-stats {
    text-align: center;
    opacity: 0.8;
}

.char-stats p {
    margin: 5px 0;
    font-size: 14px;
}

.char-stats span {
    font-weight: 700;
    color: #000000;
}

/* =============================
   RESPONSIVE DESIGN
============================= */
@media (max-width: 768px) {
    h1 {
        font-size: 1.8rem;
    }
    
    h2 {
        font-size: 1.4rem;
    }
    
    .navbar {
        gap: 6px;
        padding: 12px 8px;
    }
    
    .nav-btn {
        padding: 8px 16px;
        font-size: 13px;
    }
    
    .menu-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .menu-button {
        padding: 20px 15px;
    }
    
    .menu-icon {
        font-size: 40px;
    }
    
    .page {
        padding: 20px 10px;
    }
}

@media (max-width: 480px) {
    .navbar {
        position: relative;
    }
    
    .nav-btn {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .menu-grid {
        grid-template-columns: 1fr;
    }
}

/* =============================
   SMOOTH SCROLLING
============================= */
html {
    scroll-behavior: smooth;
}

/* =============================
   LOADING ANIMATION
============================= */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* =============================
   FLASHCARD TOGGLE
============================= */
.flashcard-toggle-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
    padding: 15px;
    background: rgba(255, 182, 217, 0.1);
    border-radius: 12px;
}

/* Flashcard flip styles */
.flashcard {
  width: 220px;
  height: 140px;
  perspective: 1000px;
  cursor: pointer;
  margin: 0 auto 12px auto;
  filter: drop-shadow(0 8px 16px rgba(93, 78, 109, 0.12));
}
.flashcard-inner {
  width: 100%;
  height: 100%;
  position: relative;
  transform-style: preserve-3d;
  transition: transform 460ms cubic-bezier(.22,.9,.37,1);
}
.flashcard-front, .flashcard-back {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 56px;
  font-weight: 800;
  border-radius: 12px;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  border: 3px solid rgba(93, 78, 109, 0.15);
}
.flashcard-back {
  background: linear-gradient(180deg, color-mix(in srgb, var(--accent-1) 18%, white 82%), color-mix(in srgb, var(--accent-3) 10%, white 90%));
  color: var(--accent-1);
  transform: rotateY(0deg);
  padding: 8px;
  border-color: color-mix(in srgb, var(--accent-1) 25%, transparent);
}
.flashcard-front {
  background: linear-gradient(180deg, color-mix(in srgb, var(--accent-2) 20%, white 80%), color-mix(in srgb, var(--accent-1) 20%, white 80%));
  color: #000000;
  transform: rotateY(180deg);
  font-size: 72px;
  color: #000000;
  border-color: color-mix(in srgb, var(--accent-2) 25%, transparent);
}
.flashcard.revealed .flashcard-inner { transform: rotateY(180deg); }

.flashcard-info { 
  transition: opacity 260ms ease, transform 260ms ease; 
}

.flash-meaning {
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  transition: opacity 260ms ease, max-height 260ms ease;
}

.flash-meaning.visible {
  opacity: 1;
  max-height: 100px;
}

.flashcard.revealed ~ .flashcard-info { opacity: 1; transform: translateY(0); }

/* =============================
   FOOTER
============================= */
footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
  background: linear-gradient(90deg, 
    color-mix(in srgb, var(--accent-3) 15%, white 85%), 
    color-mix(in srgb, var(--accent-4) 12%, white 88%),
    color-mix(in srgb, var(--accent-1) 12%, white 88%));
  color: #000000;
    padding: 8px 0;
    font-size: 15px;
    z-index: 10;
    text-align: center;
    box-shadow: 0 -2px 10px rgba(93, 78, 109, 0.15);
    border-top: 3px solid var(--accent-1);
}

body.dark-mode footer {
    background: rgba(16,16,20,0.95);
}

/* =============================
   DARK BUTTON
============================= */
#darkModeBtn {
    margin-left: 12px;
    padding: 4px 14px;
    border-radius: 18px;
    border: none;
    background: var(--accent-1);
    color: #000000;
    cursor: pointer;
    font-size: 14px;
}

/* =============================
   STROKE MASTER CHALLENGE
============================= */
.stroke-challenge-area {
    display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 28px;
  max-width: 1380px;
  margin: 24px auto;
  padding: 20px 24px;
}

.stroke-reference-box,
.stroke-drawing-box {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 100%;
    min-width: 0;
}

.stroke-reference-box h3,
.stroke-drawing-box h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #000000;
    font-weight: 600;
}

#strokeReferenceSvg {
    display: block;
    width: 100%;
    max-width: 100%;
  height: auto;
  aspect-ratio: 1;
  border: 3px solid #e2e8f0;
  border-radius: 12px;
  background: white;
  object-fit: contain;
}

.stroke-drawing-box {
    position: relative;
}

.stroke-canvas-container {
    position: relative;
  width: 100%;
  aspect-ratio: 1;
  margin: 0 auto;
  border: 3px solid #e2e8f0;
  border-radius: 12px;
}

#strokeDrawingSvg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  border-radius: 12px;
    background: white;
    pointer-events: none;
    z-index: 1;
}

#strokeChallengeCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: crosshair;
    touch-action: none;
    background: transparent;
    z-index: 2;
  border-radius: 12px;
}

@media (max-width: 768px) {
    .stroke-challenge-area {
        grid-template-columns: 1fr;
        max-width: 100%;
        padding: 12px;
    }
}

/* =============================
   WRITING PRACTICE SECTION
============================= */
.writing-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 24px;
}

.wp-char-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 8px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    max-height: 600px;
    overflow-y: auto;
}

.wp-char-grid .char-button {
    width: 40px;
    height: 40px;
    border: 2px solid #e2e8f0;
    background: white;
    color: #000000;
    font-size: 18px;
    font-weight: 600;
    border-radius: 6px;
    cursor: pointer;
    transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wp-char-grid .char-button:hover {
    border-color: #000000;
    background: #f7fafc;
}

.wp-char-grid .char-button.active {
    background: #5d4e6d;
    color: #000000;
    border-color: #000000;
}

.wp-main-area {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.wp-practice-box {
    position: relative;
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    aspect-ratio: 1;
}

#wp-stroke-svg {
    display: block;
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    pointer-events: none;
}

#wp-draw-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: crosshair;
    touch-action: none;
    z-index: 2;
}

.wp-controls {
    max-width: 500px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.wp-button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.wp-options {
    display: flex;
    gap: 16px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
}

.wp-check {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

.wp-check input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.wp-info-text {
    padding: 12px;
    background: rgba(93, 78, 109, 0.1);
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
    color: #000000;
    font-weight: 600;
}

@media (max-width: 968px) {
    .writing-container {
        grid-template-columns: 1fr;
    }
    
    .wp-char-grid {
        max-height: 200px;
        grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
    }
}

/* Styling for the new Writing Practice section */
.writing-practice-app {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 24px;
  max-width: 1200px;
  margin: 20px auto;
  padding: 20px;
}

.wp-app-main {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.wp-app-canvas-container {
  position: relative;
  aspect-ratio: 1 / 1;
  border-radius: 12px;
  overflow: hidden;
  background: linear-gradient(180deg, #fdfcfa, #f8f5f0);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 2px solid rgba(93, 78, 109, 0.2);
}

body.dark-mode .wp-app-canvas-container {
  background: linear-gradient(180deg, #1a1a24, #20202c);
  border-color: #000000;
}

.wp-app-canvas-container svg,
.wp-app-canvas-container canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}

#wp-app-stroke-svg {
  pointer-events: none;
}

#wp-app-draw-canvas {
  display: block;
  touch-action: none;
  cursor: crosshair;
}

.wp-app-controls-bar {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.wp-app-sidebar {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.wp-app-sidebar-card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(93, 78, 109, 0.1);
  border: 2px solid rgba(93, 78, 109, 0.15);
}

body.dark-mode .wp-app-sidebar-card {
  background: #2a2a35;
  border-color: #000000;
}

.wp-app-sidebar-card label {
  display: block;
  font-weight: 600;
  color: #000000;
  margin-bottom: 10px;
}

body.dark-mode .wp-app-sidebar-card label {
  color: #000000;
}

.wp-app-sidebar-card select,
.wp-app-sidebar-card input[type="range"] {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(93, 78, 109, 0.3);
  background: #f9f8f4;
  font-size: 14px;
}

body.dark-mode .wp-app-sidebar-card select,
body.dark-mode .wp-app-sidebar-card input[type="range"] {
  background: #1a1a24;
  border-color: #000000;
  color: #000000;
}

.shortcuts-info {
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-size: 13px;
  color: #000000;
}
body.dark-mode .shortcuts-info {
  color: #000000;
}
.shortcuts-info span b {
  display: inline-block;
  width: 20px;
  text-align: center;
  background: rgba(93, 78, 109, 0.1);
  border-radius: 4px;
  padding: 2px 4px;
  margin-right: 8px;
  color: #000000;
}
body.dark-mode .shortcuts-info span b {
  background: rgba(139, 111, 71, 0.2);
  color: #000000;
}


@media (max-width: 968px) {
    .writing-practice-app {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>

<div id="app">

<canvas id="floatingCanvas"></canvas>

<header>
  <h1>Japanese Learning Platform</h1>
  <p style="text-align:center;">
    Hiragana ‚Ä¢ Katakana ‚Ä¢ Kanji ‚Äî Stroke Practice & Games
  </p>

  <nav class="navbar">
    <button id="navBackBtn" class="nav-btn" type="button" onclick="UI.goBack()" aria-label="Go back to previous section" disabled>‚üµ Back</button>
    <a class="nav-btn" href="#menu" onclick="event.preventDefault(); UI.showSection('menu');">üè† Home</a>
    <a class="nav-btn" href="#curriculum" onclick="event.preventDefault(); UI.showSection('curriculum');">Curriculum</a>
    <a class="nav-btn" href="#flashcards" onclick="event.preventDefault(); UI.showSection('flashcards');">Flashcards</a>
    <a class="nav-btn" href="#quiz" onclick="event.preventDefault(); UI.showSection('quiz');">Quiz</a>
    <a class="nav-btn" href="#game" onclick="event.preventDefault(); UI.showSection('game');">Speed Game</a>
    <a class="nav-btn" href="#writing" onclick="event.preventDefault(); UI.showSection('writing');">‚úçÔ∏è Writing</a>
    <a class="nav-btn" href="#minigames" onclick="event.preventDefault(); UI.showSection('minigames');">Mini-Games</a>
  </nav>
</header>

<div id="loadingScreen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #faf9f5 0%, #f4f2ed 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
">
    <div style="
        font-size: 80px;
        margin-bottom: 20px;
        animation: float 3s ease-in-out infinite;
    ">üå∏</div>
    <h2 style="
        background: linear-gradient(135deg, #5d4e6d, #8b6f47);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-size: 2rem;
        margin: 0;
    ">Loading Japanese Learning Platform...</h2>
    <div style="
        width: 200px;
        height: 4px;
        background: rgba(93, 78, 109, 0.15);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 20px;
    ">
        <div style="
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #5d4e6d, #8b6f47);
            animation: loading 1.5s ease-in-out infinite;
        "></div>
    </div>
</div>

<style>
@keyframes loading {
    0%, 100% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
}
</style>

<div class="site-content" style="transition: opacity 0.5s ease;">

<section id="menu" class="page">
    <h2 style="margin-top: 0px; margin-bottom: 50px;">üå∏ Choose Your Learning Mode</h2>

    <div class="home-hero">
      <div class="home-hero-bg"></div>
      <div class="menu-grid">
        <a class="menu-button" href="#curriculum" onclick="event.preventDefault(); UI.showSection('curriculum');">
          <div class="menu-icon" aria-hidden="true">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="4" y="5" width="16" height="14" rx="2" data-fill="accent"/>
              <path d="M8 9h8M8 12h8M8 15h4" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="menu-title">Curriculum</div>
          <div class="menu-desc">Guided path & progress</div>
        </a>

        <a class="menu-button" href="#flashcards" onclick="event.preventDefault(); UI.showSection('flashcards');">
          <div class="menu-icon" aria-hidden="true">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="6" width="14" height="12" rx="2" data-fill="primary"/>
              <rect x="7" y="3" width="14" height="12" rx="2" data-fill="accent"/>
            </svg>
          </div>
          <div class="menu-title">Flashcards</div>
          <div class="menu-desc">Recognition and vocabulary</div>
        </a>

        <a class="menu-button" href="#quiz" onclick="event.preventDefault(); UI.showSection('quiz');">
          <div class="menu-icon" aria-hidden="true">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="9" data-fill="accent"/>
              <path d="M11 10h2v2a1 1 0 01-2 0v-2z" fill="#fff"/>
              <path d="M12 7a1.25 1.25 0 110 2.5A1.25 1.25 0 0112 7z" fill="#fff"/>
            </svg>
          </div>
          <div class="menu-title">Quiz</div>
          <div class="menu-desc">Reading comprehension</div>
        </a>

        <a class="menu-button" href="#writing" onclick="event.preventDefault(); UI.showSection('writing');">
          <div class="menu-icon" aria-hidden="true">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" data-fill="primary"/>
              <path d="M20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" data-fill="accent"/>
            </svg>
          </div>
          <div class="menu-title">Writing Practice</div>
          <div class="menu-desc">Stroke writing practice</div>
        </a>

        <a class="menu-button" href="#game" onclick="event.preventDefault(); UI.showSection('game');">
          <div class="menu-icon" aria-hidden="true">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13 2L3 14h10l-1 8 11-12H13z" data-fill="primary"/>
            </svg>
          </div>
          <div class="menu-title">Speed Game</div>
          <div class="menu-desc">Timed drawing challenge</div>
        </a>

        <a class="menu-button" href="#minigames" onclick="event.preventDefault(); UI.showSection('minigames');">
          <div class="menu-icon" aria-hidden="true">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 10v4a2 2 0 002 2h1l1 2h4l1-2h1a2 2 0 002-2v-4a2 2 0 00-2-2h-8a2 2 0 00-2 2z" data-fill="accent"/>
              <circle cx="9" cy="12" r="1" fill="#fff"/>
              <circle cx="15" cy="12" r="1" fill="#fff"/>
            </svg>
          </div>
          <div class="menu-title">Mini-Games</div>
          <div class="menu-desc">Fun learning challenges</div>
        </a>
    </div>
      </div>
    </div>
  </section>

<script>
  function animateMenuSVGs() {
    const svgs = document.querySelectorAll('.menu-icon svg');
    svgs.forEach((svg, idx) => {
      // target path elements that have a data-fill attribute
      const paths = svg.querySelectorAll('[data-fill]');
      paths.forEach((p, pidx) => {
        try {
          const len = p.getTotalLength ? p.getTotalLength() : 100;
          p.style.strokeDasharray = len;
          p.style.strokeDashoffset = len;
          p.style.strokeWidth = Math.max(1, Math.min(2, Math.round(len/60)));
          // set stroke color to computed fill for consistency
          const cs = window.getComputedStyle(p);
          const fill = cs.fill || cs.getPropertyValue('fill');
          if (fill) p.style.stroke = fill;
          p.style.fillOpacity = 1;
          p.style.transition = `stroke-dashoffset 520ms cubic-bezier(.22,.9,.37,1) ${idx*80 + pidx*60}ms, opacity 240ms ease ${idx*80 + pidx*60}ms`;
          // trigger after a short delay
          setTimeout(()=> { p.style.strokeDashoffset = '0'; }, 50 + idx*80 + pidx*60);
        } catch (e) {
          // ignore svg paths that don't support getTotalLength
        }
      });
    });
  }

  // run after DOM ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(animateMenuSVGs, 120); else document.addEventListener('DOMContentLoaded', () => setTimeout(animateMenuSVGs, 120));
</script>

<section id="curriculum" class="page hidden">
  <h2>üìò Curriculum Path</h2>
  <p class="curriculum-desc" style="text-align:center; max-width: 800px; margin: 0 auto 18px auto;">
    Follow a guided path through kana and core vocabulary. Your progress and weak characters are tracked locally.
  </p>
  <div class="curriculum-hero">
    <div class="curriculum-hero-copy">
      <div class="pill">Guided journey</div>
      <h3>Stay on track with clear milestones.</h3>
      <p>See what is done, what is next, and jump back into any lesson instantly.</p>
      <div class="curriculum-filters" role="group" aria-label="Lesson filters">
        <button class="filter-pill active" data-filter="all">All</button>
        <button class="filter-pill" data-filter="in-progress">In progress</button>
        <button class="filter-pill" data-filter="not-started">Not started</button>
        <button class="filter-pill" data-filter="completed">Completed</button>
      </div>
        <div class="curriculum-hero-actions">
          <button id="currResumeBtn" class="pill-button primary">Resume last lesson</button>
              <button id="currUnseenBtn" class="pill-button ghost">Review due cards</button>
        </div>
            <div class="curriculum-shortcuts" id="curriculumShortcuts" aria-live="polite">
              <button id="currShortcutNext" class="shortcut-card">
                <div class="shortcut-title">Next up</div>
                <div class="shortcut-desc" id="currShortcutNextLabel">Loading‚Ä¶</div>
              </button>
              <button id="currShortcutGaps" class="shortcut-card">
                <div class="shortcut-title">Fill gaps</div>
                <div class="shortcut-desc" id="currShortcutGapLabel">-- gaps</div>
              </button>
              <button id="currShortcutSRS" class="shortcut-card ghost">
                <div class="shortcut-title">SRS due</div>
                <div class="shortcut-desc" id="currShortcutSrsLabel">-- due</div>
              </button>
            </div>
    </div>
    <div class="curriculum-stats-grid">
      <div class="curriculum-stat" onclick="UI.showSection('curriculum')" style="cursor: pointer;" title="View all lessons">
        <span class="label">Lessons</span>
        <span class="value" id="currStatLessons">--</span>
      </div>
      <div class="curriculum-stat" onclick="UI.showSection('curriculum')" style="cursor: pointer;" title="View unique characters">
        <span class="label">Unique chars</span>
        <span class="value" id="currStatChars">--</span>
      </div>
      <div class="curriculum-stat" onclick="UI.showSection('flashcards')" style="cursor: pointer;" title="Study mastered items">
        <span class="label">Mastered</span>
        <span class="value" id="currStatSeen">--</span>
      </div>
      <div class="curriculum-stat" onclick="UI.showSection('quiz')" style="cursor: pointer;" title="Practice vocabulary">
        <span class="label">Vocab items</span>
        <span class="value" id="currStatVocab">--</span>
      </div>
    </div>
  </div>

  <div class="curriculum-legend">
    <div class="legend-item"><span class="dot seen"></span>Seen</div>
    <div class="legend-item"><span class="dot new"></span>New</div>
    <div class="legend-item"><span class="dot vocab"></span>Vocab preview</div>
  </div>

  <div class="curriculum-rail">
    <div class="rail-head">
      <div>
        <div class="pill">Core Track</div>
        <h4>All lessons</h4>
      </div>
      <div class="rail-controls">
        <label for="currSortSelect">Sort:</label>
        <select id="currSortSelect">
          <option value="order">Track order</option>
          <option value="progress-desc">Progress ‚Üì</option>
          <option value="progress-asc">Progress ‚Üë</option>
          <option value="alpha">A ‚Üí Z</option>
        </select>
        <button class="ghost-btn" onclick="UI.showSection('flashcards')">Jump to Flashcards</button>
      </div>
    </div>
    <div id="curriculumList" class="curriculum-grid" aria-live="polite"></div>
  </div>
  <div class="keyboard-hint" style="text-align:center;">Progress is saved in your browser; switch sections anytime.</div>
</section>

<section id="flashcards" class="page hidden">
  <h2>üÉè Flashcards & Vocabulary</h2>

  <div class="flashcard-toggle-container">
    <button id="flashHiraganaBtn" class="toggle-btn active">„Å≤„Çâ„Åå„Å™ Hiragana</button>
    <button id="flashKatakanaBtn" class="toggle-btn">„Ç´„Çø„Ç´„Éä Katakana</button>
    <button id="flashKanjiBtn" class="toggle-btn">Êº¢Â≠ó Kanji</button>
    <button id="flashCombosBtn" class="toggle-btn">„Åç„ÇÉ Combos</button>
    <button id="flashAllBtn" class="toggle-btn">All</button>
  </div>

  <div id="flashLessonBanner" class="flash-lesson-banner hidden" aria-live="polite">
    <span id="flashLessonText">Lesson mode</span>
    <button onclick="Flashcards.clearLessonOverride()">Exit lesson</button>
  </div>

  <div class="flashcard-header">
    <div class="flashcard-progress">
      <p id="cardProgressText">Card 0/0</p>
      <div class="progress-container">
        <div id="cardProgressBar" class="progress-bar"></div>
      </div>
    </div>
    <div class="flashcard-stats">
      <div>Reviewed: <span id="cardReviewed">0</span></div>
      <div>Streak: <span id="cardStreak">0</span></div>
    </div>
  </div>

  <div class="flashcard-grid">
    <div>
      <div id="flashDisplay" class="flashcard">
        <div class="flashcard-character"></div>
      </div>
      <div class="flashcard-info">
        <div id="flashRomaji" class="flash-romaji"></div>
        <div id="flashMeaning" class="flash-meaning"></div>
      </div>
      <div class="flashcard-controls">
        <div class="nav-controls">
          <button class="pink-btn small-btn" onclick="Flashcards.prev()" aria-label="Previous character">‚üµ Prev</button>
          <button class="pink-btn small-btn" onclick="Flashcards.next()" aria-label="Next character">Next ‚ü∂</button>
        </div>
        <div class="audio-controls">
          <button id="playCharBtn" class="audio-btn" onclick="Flashcards.playPronunciation()" aria-label="Play character pronunciation">
            <span class="audio-icon">üîä</span>
            <span class="audio-label">Character</span>
          </button>
          <button id="playAllBtn" class="audio-btn secondary" onclick="Flashcards.playAllExamples()" aria-label="Play all examples">
            <span class="audio-icon">üéµ</span>
            <span class="audio-label">All Examples</span>
          </button>
        </div>
        <button id="flashToggleMeaning" class="pink-btn small-btn" onclick="Flashcards.toggleMeaning()">Show Meaning</button>
      </div>

      <div id="srsPanel" class="srs-panel">
        <div class="srs-row">
          <span class="srs-pill">SRS</span>
          <span id="srsDueCount" class="srs-count">0 due</span>
          <span id="srsNewCount" class="srs-count muted">0 new</span>
        </div>
        <div class="srs-actions">
          <button id="srsReviewBtn" class="pill-button primary small">Review due</button>
          <button id="srsAddCurrentBtn" class="pill-button ghost small">Add current</button>
        </div>
        <div class="srs-grade">
          <button class="srs-btn again" data-grade="again">Again</button>
          <button class="srs-btn hard" data-grade="hard">Hard</button>
          <button class="srs-btn good" data-grade="good">Good</button>
          <button class="srs-btn easy" data-grade="easy">Easy</button>
        </div>
        <div id="srsStatus" class="srs-status">Spaced repetition is ready.</div>
      </div>
    </div>

    <div class="flashcard-details">
      <div class="flash-main">
        <h3>Example Words</h3>
        <div class="flash-examples">
          <ul id="flashExamples" class="flash-examples-list"></ul>
        </div>
      </div>
      <div class="keyboard-hint">
        Use navigation buttons to browse characters. Click audio buttons to hear pronunciation.
      </div>
    </div>
  </div>
</section>

<section id="quiz" class="page hidden">
  <h2>‚ùì Reading Quiz</h2>

  <div class="quiz-header">
    <div class="quiz-score">
      <p>Score: <span id="quizScore">0</span> / <span id="quizTotal">0</span></p>
      <p>Streak: <span id="quizStreak">0</span></p>
      <div class="progress-container">
        <div id="quizProgressBar" class="progress-bar"></div>
      </div>
    </div>
  </div>

  <div class="quiz-options">
    <div id="quizLessonBanner" class="flash-lesson-banner hidden" aria-live="polite" style="margin-bottom:8px;">
      <span id="quizLessonText">Lesson mode</span>
      <button onclick="Quiz.clearLessonMode()">Exit lesson</button>
    </div>
    <div class="kana-toggle">
      <span class="toggle-label">Script:</span>
      <button id="hiraganaBtn" class="toggle-btn active" onclick="Quiz.setMode('hiragana')">„Å≤„Çâ„Åå„Å™ Hiragana</button>
      <button id="katakanaBtn" class="toggle-btn" onclick="Quiz.setMode('katakana')">„Ç´„Çø„Ç´„Éä Katakana</button>
      <button id="kanjiBtn" class="toggle-btn" onclick="Quiz.setMode('kanji')">Êº¢Â≠ó Kanji</button>
      <button id="combosBtn" class="toggle-btn" onclick="Quiz.setMode('combos')">„Åç„ÇÉ Combos</button>
      <button id="bothBtn" class="toggle-btn" onclick="Quiz.setMode('all')">All</button>
    </div>
    <div class="difficulty-select">
      Difficulty:
      <select id="difficultySelect" onchange="Quiz.changeDifficulty()">
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
      </select>
    </div>
  </div>

  <div id="quizQuestion" class="quiz-question">„ÅÇ</div>

  <div id="quizChoices" class="quiz-choices"></div>

  <div id="quizResult" class="quiz-result" aria-live="polite" role="status"></div>

  <div class="action-buttons">
    <button class="pink-btn small-btn" onclick="Quiz.restart()">Restart Quiz</button>
  </div>
</section>

<!-- ============================
     SPEED GAME SECTION (LESSON FOCUS)
============================= -->
<section id="game" class="page hidden">
  <h2>‚ö° Kana Focus Sprint</h2>

  <p class="game-subtitle">Choose a lesson and draw characters against the clock!</p>

  <!-- Lesson Selector -->
  <div class="game-lesson-selector">
    <label for="gameLessonSelect">Practice from:</label>
    <select id="gameLessonSelect" aria-label="Select lesson for focused practice">
      <option value="all">All Characters</option>
    </select>

  </div>

  <!-- Game Header: Timer and Score -->
  <div class="game-header">
    <div class="timer-display">
      <span id="gameTimer">60s</span>
    </div>
    <div class="game-score-display">
      <p>Completed: <span id="gameScore">0</span></p>
      <p class="game-streak">Accuracy: <span id="gameAccuracy">0</span>%</p>
    </div>
  </div>

  <!-- Target Character Display -->
  <div class="game-canvas-container">
    <canvas id="gameCanvas" width="350" height="350"></canvas>
  </div>

  <div id="gameTargetText" class="game-target">Draw: ?</div>

  <!-- Real-time Feedback -->
  <div id="gameFeedback" class="game-feedback" role="status" aria-live="polite"></div>

  <!-- Game Controls -->
  <div class="game-controls">
    <button class="pink-btn" id="gameStartBtn" onclick="Game.start()">Start Sprint</button>
    <button class="pink-btn small-btn" onclick="Game.checkAccuracy()">Check ‚úì</button>
    <button class="pink-btn small-btn" onclick="Game.submitCharacter()">Submit & Next</button>
    <button class="pink-btn small-btn" onclick="Game.clear()">Clear</button>
    <button class="pink-btn small-btn" id="eraserBtn" onclick="Game.toggleEraser()">Eraser</button>
    <button class="pink-btn small-btn" onclick="Game.undoLast()">Undo</button>
  </div>
  
  <!-- Character Selection Controls -->
  <div class="char-selection-controls">
    <button class="pink-btn" id="chooseCharBtn" onclick="Game.openCharPicker()">üìù Choose Character</button>
    <button class="pink-btn" onclick="Game.randomCharacter()">üé≤ Random</button>
  </div>

  <!-- Character Picker Modal -->
  <div id="charPickerModal" class="char-picker-modal hidden">
    <div class="char-picker-content">
      <div class="char-picker-header">
        <h3>Choose Character to Practice</h3>
        <button class="close-btn" onclick="Game.closeCharPicker()">‚úï</button>
      </div>
      <div class="char-picker-tabs">
        <button class="tab-btn active" onclick="Game.showCharTab('hiragana')">Hiragana</button>
        <button class="tab-btn" onclick="Game.showCharTab('katakana')">Katakana</button>
        <button class="tab-btn" onclick="Game.showCharTab('all')">All</button>
      </div>
      <div class="char-picker-grid" id="charPickerGrid">
        <!-- Characters will be populated here -->
      </div>
    </div>
  </div>
  
  <!-- Game Over Stats -->
  <div id="gameStats" class="game-stats-display hidden">
    <h3>üéØ Sprint Complete!</h3>
    <p class="final-stat">Characters Completed: <span id="finalCharacters">0</span></p>
    <p class="final-stat">Attempts: <span id="finalAttempts">0</span></p>
    <p class="final-stat">Accuracy: <span id="finalAccuracy">0</span>%</p>
    <p class="final-stat">Characters per Minute: <span id="finalCPM">0</span></p>
    <button class="pink-btn" onclick="Game.start()">Play Again</button>
    <button class="pink-btn small-btn" onclick="UI.showSection('menu')">Back to Menu</button>
  </div>
</section>

<section id="minigames" class="page hidden">
  <h2>üéÆ Mini-Games Hub</h2>
  
  <div class="minigames-menu">
    <button class="minigame-card" onclick="MiniGames.startMemoryMatch()">
      <div class="minigame-icon">üé¥</div>
      <div class="minigame-title">Memory Match</div>
      <div class="minigame-desc">Match kana pairs</div>
    </button>
    
    <button class="minigame-card" onclick="MiniGames.startQuickQuiz()">
      <div class="minigame-icon">‚ö°</div>
      <div class="minigame-title">Lightning Quiz</div>
      <div class="minigame-desc">Fast-paced quiz challenge</div>
    </button>
    
    <button class="minigame-card" onclick="MiniGames.startStrokeChallenge()">
      <div class="minigame-icon">üñåÔ∏è</div>
      <div class="minigame-title">Stroke Master</div>
      <div class="minigame-desc">Draw perfect strokes</div>
    </button>
  </div>

  <div id="memoryMatch" class="minigame-container hidden">
    <h3>üé¥ Kana Memory Match</h3>
    <div class="game-stats-mini">
      <span>Pairs: <span id="memoryPairs">0</span>/8</span>
      <span>Moves: <span id="memoryMoves">0</span></span>
      <span>Time: <span id="memoryTime">0</span>s</span>
    </div>
    <div id="memoryGrid" class="memory-grid" role="grid" aria-label="Memory match game grid"></div>
    <button class="pink-btn small-btn" onclick="MiniGames.resetMemory()">New Game</button>
    <button class="pink-btn small-btn" onclick="MiniGames.backToHub()">Back</button>
  </div>

  <div id="quickQuiz" class="minigame-container hidden">
    <h3>‚ö° Lightning Quiz</h3>
    <div id="quickQuiz_lesson" class="lesson-badge hidden"></div>
    <div class="game-stats-mini">
      <span>Score: <span id="quickQuiz_score">0</span></span>
      <span>Streak: <span id="quickQuiz_streak">0</span></span>
      <span>Time: <span id="quickQuiz_time">30</span></span>
      <label class="inline-select">Difficulty:
        <select id="quickQuiz_difficulty" onchange="MiniGames.setQuickQuizDifficulty(this.value)">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
        </select>
      </label>
    </div>
    <div id="quickQuiz_question" class="quick-quiz-question" role="heading" aria-level="3" aria-live="polite">?</div>
    <div id="quickQuiz_choices" class="quick-quiz-choices" role="group" aria-label="Answer choices"></div>
    <div id="quickQuiz_result" class="quiz-result-mini"></div>
    <button class="pink-btn small-btn" onclick="MiniGames.backToHub()">Back</button>
  </div>

  <div id="strokeChallenge" class="minigame-container hidden">
    <h3>üñåÔ∏è Stroke Master Challenge</h3>
    <div class="game-stats-mini">
      <span>Score: <span id="strokeScore">0</span></span>
      <span>Perfect: <span id="strokePerfect">0</span></span>
      <span>Target: <span id="strokeTarget">„ÅÇ</span></span>
      <span>Accuracy: <span id="strokeAccuracy">-</span>%</span>
    </div>
    <div class="stroke-tuning">
      <label>Brush Size <span id="strokeBrushVal">12</span></label>
      <input id="strokeBrushRange" type="range" min="2" max="32" value="12">
      <label>Guide Opacity <span id="strokeGuideVal">28</span>%</label>
      <input id="strokeGuideRange" type="range" min="0" max="100" value="28">
      <label>Export Size</label>
      <select id="strokeExportSize">
        <option value="auto" selected>Match Screen</option>
        <option value="1024">1024 px</option>
        <option value="1400">1400 px</option>
      </select>
      <div class="stroke-hotkeys">Shortcuts: C = Clear ¬∑ Z = Undo ¬∑ S = Save</div>
    </div>
    <div class="stroke-challenge-area">
      <div class="stroke-reference-box">
        <h3>Reference</h3>
        <svg id="strokeReferenceSvg" viewBox="0 0 140 140" preserveAspectRatio="xMidYMid meet">
          <defs>
            <pattern id="stroke-grid" width="10" height="10" patternUnits="userSpaceOnUse">
              <rect width="10" height="10" fill="none" stroke="#eee" stroke-width="0.5"/>
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#stroke-grid)"/>
        </svg>
      </div>
      <div class="stroke-drawing-box">
        <h3>Your Drawing</h3>
        <div class="stroke-canvas-container">
          <svg id="strokeDrawingSvg" viewBox="0 0 140 140" preserveAspectRatio="xMidYMid meet">
            <defs>
              <pattern id="stroke-grid-draw" width="10" height="10" patternUnits="userSpaceOnUse">
                <rect width="10" height="10" fill="none" stroke="#eee" stroke-width="0.5"/>
              </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#stroke-grid-draw)"/>
          </svg>
          <canvas id="strokeChallengeCanvas"></canvas>
        </div>
      </div>
    </div>
    <div class="stroke-challenge-controls">
      <button class="pink-btn small-btn" onclick="MiniGames.clearStrokeCanvas()">Clear</button>
      <button class="pink-btn small-btn" onclick="MiniGames.undoStrokeCanvas()">Undo</button>
      <button class="pink-btn small-btn" onclick="MiniGames.checkStroke()">Check</button>
      <button class="pink-btn small-btn" onclick="MiniGames.nextStrokeChallenge()">Skip</button>
      <button class="pink-btn small-btn" onclick="MiniGames.downloadStrokePng()">Download PNG</button>
      <button class="pink-btn small-btn" onclick="MiniGames.backToHub()">Back</button>
    </div>
    <div id="strokeFeedback" class="stroke-feedback"></div>
  </div>
</section>

<!-- =============================
     WRITING PRACTICE SECTION (NEW)
============================= -->
<section id="writing" class="page hidden">
  <h2>‚úçÔ∏è Character Drawing Practice</h2>
  <p class="game-subtitle">Practice drawing Hiragana, Katakana, and Kanji characters.</p>

  <div class="writing-practice-app">
    <div class="wp-app-main">
      <div class="wp-app-canvas-container">
        <svg id="wp-app-stroke-svg" class="wp-app-stroke-svg" viewBox="0 0 140 140"></svg>
        <canvas id="wp-app-draw-canvas"></canvas>
      </div>
      <div class="wp-app-controls-bar">
        <button id="wp-app-clear-btn" class="pink-btn small-btn">Clear</button>
        <button id="wp-app-undo-btn" class="pink-btn small-btn">Undo</button>
        <button id="wp-app-download-btn" class="pink-btn small-btn">Download PNG</button>
      </div>
      <div id="wp-app-flash-message" class="wp-app-flash"></div>
      <div id="wp-app-current-info" class="wp-app-info"></div>
    </div>
    <aside class="wp-app-sidebar">
      <div class="wp-app-sidebar-card">
        <label for="wp-app-char-select">Character Select</label>
        <select id="wp-app-char-select"></select>
      </div>
      <div class="wp-app-sidebar-card">
        <label for="wp-app-line-width">Brush Size: <span id="wp-app-line-width-val">12</span></label>
        <input id="wp-app-line-width" type="range" min="1" max="40" value="12">
      </div>
      <div class="wp-app-sidebar-card">
        <label for="wp-app-target-opacity">Guideline Opacity: <span id="wp-app-opacity-val">28</span>%</label>
        <input id="wp-app-target-opacity" type="range" min="0" max="100" value="28">
      </div>
      <div class="wp-app-sidebar-card">
        <label>Keyboard Shortcuts</label>
        <div class="shortcuts-info">
          <span><b>C</b> - Clear</span>
          <span><b>Z</b> - Undo</span>
          <span><b>S</b> - Save</span>
        </div>
      </div>
    </aside>
  </div>
</section>

</div>

<footer>
    <div class="footer-content">
        <div class="footer-info">
            <span class="footer-icon">üå∏</span>
            <span>Japanese Learning Platform ¬© 2025</span>
        </div>
        <button id="darkModeBtn" class="dark-mode-toggle">
            <span class="toggle-icon">üåô</span>
            <span class="toggle-text">Dark Mode</span>
        </button>
        <button id="animationToggleBtn" class="dark-mode-toggle" title="Toggle floating characters">
          <span class="toggle-icon">„ÅÇ</span>
          <span class="toggle-text">Animation</span>
        </button>
    </div>
</footer>

<style>
footer {
    background: linear-gradient(135deg, 
        color-mix(in srgb, var(--accent-3) 30%, white),
        color-mix(in srgb, var(--accent-4) 30%, white),
        color-mix(in srgb, var(--accent-1) 25%, white));
    padding: 25px 20px;
    text-align: center;
    box-shadow: 0 -4px 20px rgba(93, 78, 109, 0.15);
    border-top: 3px solid var(--accent-1);
    position: relative;
    z-index: 10;
}

.footer-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.footer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #000000;
}

.footer-icon {
    font-size: 1.5rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.dark-mode-toggle {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
    color: #000000;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(93, 78, 109, 0.3);
    transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
}

.dark-mode-toggle:hover {
    background: linear-gradient(135deg, var(--accent-2), var(--accent-1));
    box-shadow: 0 6px 16px rgba(93, 78, 109, 0.4);
}

.toggle-icon {
    font-size: 1.2rem;
}

body.dark-mode footer {
    background: linear-gradient(135deg, #1a1a25, #2a2a35);
    border-top-color: var(--accent-1);
}

body.dark-mode .footer-info {
    color: #000000;
}

@media (max-width: 600px) {
    .footer-content {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
// Add hidden class style if not already defined
(function() {
  if (!document.querySelector('style[data-ui-styles]')) {
    const style = document.createElement('style');
    style.setAttribute('data-ui-styles', 'true');
    style.textContent = `.page.hidden { display: none; }`;
    document.head.appendChild(style);
  }
})();
</script>

<script>
const app = document.getElementById("app");
const canvas = document.getElementById("floatingCanvas");
const ctx = canvas.getContext("2d");

let characters = [];
let animationEnabled = true;
let cachedWidth = 0;
let cachedHeight = 0;

// Japanese characters to float (hiragana, katakana, common kanji)
const kanaChars = [
    '„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä', '„Åã', '„Åç', '„Åè', '„Åë', '„Åì',
    '„Åï', '„Åó', '„Åô', '„Åõ', '„Åù', '„Åü', '„Å°', '„Å§', '„Å¶', '„Å®',
    '„Å™', '„Å´', '„Å¨', '„Å≠', '„ÅÆ', '„ÅØ', '„Å≤', '„Åµ', '„Å∏', '„Åª',
    '„Ç¢', '„Ç§', '„Ç¶', '„Ç®', '„Ç™', '„Ç´', '„Ç≠', '„ÇØ', '„Ç±', '„Ç≥',
    'Êó•', 'Êú¨', 'Ë™û', 'Â≠¶', 'Áøí', 'Êñá', 'Â≠ó', 'Âãâ', 'Âº∑', 'Ë™≠'
];

function resize() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    cachedWidth = app.clientWidth;
    cachedHeight = app.clientHeight;

    canvas.style.width = cachedWidth + "px";
    canvas.style.height = cachedHeight + "px";
    canvas.width = Math.round(cachedWidth * dpr);
    canvas.height = Math.round(cachedHeight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

// Throttle resize to prevent excessive redraws
let resizeTimeout;
window.addEventListener("resize", () => {
    if (resizeTimeout) clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(resize, 150);
});
resize();

function getMaxChars() {
    const w = cachedWidth || window.innerWidth;
    if (w > 1400) return 5;
    if (w > 1000) return 4;
    if (w > 700) return 3;
    return 2;
}

function makeCharacter() {
    const char = kanaChars[Math.floor(Math.random() * kanaChars.length)];
    const size = 20 + Math.random() * 30;
    const depth = 0.3 + Math.random() * 0.7;
    
    return {
        char: char,
        x: Math.random() * cachedWidth,
        y: -50 - Math.random() * 100,
        size: size,
        speed: (0.3 + Math.random() * 0.8) * depth,
        drift: (Math.random() - 0.5) * 0.4,
        rotation: Math.random() * Math.PI * 2,
        rotationSpeed: (Math.random() - 0.5) * 0.02,
        opacity: 0.05 + Math.random() * 0.03,
        depth: depth,
        sway: Math.random() * Math.PI * 2,
        swaySpeed: 0.008 + Math.random() * 0.015
    };
}

// Seed initial characters
(function seedInitial() {
    const max = getMaxChars();
    const seed = Math.floor(max * 0.5);
    for (let i = 0; i < seed; i++) {
        const c = makeCharacter();
        c.y = Math.random() * cachedHeight;
        characters.push(c);
    }
})();

function drawCharacter(c) {
    ctx.save();
    ctx.globalAlpha = c.opacity * c.depth;
    ctx.translate(c.x, c.y);
    ctx.rotate(c.rotation);
    
    ctx.font = `${Math.round(c.size)}px "Hiragino Sans", sans-serif`;
    ctx.fillStyle = '#5d4e6d';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(c.char, 0, 0);
    
    ctx.restore();
}

function animate(timestamp) {
    if (!animationEnabled) {
        // Still request next frame even when disabled, so we can enable it later
        requestAnimationFrame(animate);
        return;
    }

    // Use requestAnimationFrame without frame rate limiting for smooth animation
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const maxChars = getMaxChars();
    if (characters.length < maxChars && Math.random() < 0.15) {
        characters.push(makeCharacter());
    }

    for (const c of characters) {
        c.y += c.speed;
        c.sway += c.swaySpeed;
        const swayX = Math.sin(c.sway) * 15 * c.depth;
        c.x += c.drift + swayX * 0.05;
        c.rotation += c.rotationSpeed;

        if (c.x < -100) c.x = cachedWidth + 100;
        if (c.x > cachedWidth + 100) c.x = -100;

        drawCharacter(c);
    }

    characters = characters.filter(c => c.y < cachedHeight + 100);
    requestAnimationFrame(animate);
}
// Start animation loop - will check animationEnabled flag each frame
requestAnimationFrame(animate);

// Canvas click burst effect removed since canvas has pointer-events: none
// This allows users to click through to interact with content below
</script>

<script>
const btn = document.getElementById("darkModeBtn");

btn.addEventListener("click",()=>{
    const isDark = document.body.classList.toggle("dark-mode");
    const toggleText = btn.querySelector('.toggle-text');
    const toggleIcon = btn.querySelector('.toggle-icon');
    if (toggleText && toggleIcon) {
        toggleText.textContent = isDark ? "Light Mode" : "Dark Mode";
        toggleIcon.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    }
});

const animationToggleBtn = document.getElementById('animationToggleBtn');
if (animationToggleBtn) {
  const saved = localStorage.getItem('animationEnabled');
  if (saved === null) {
    animationEnabled = true; // Enabled by default for Edo animations
    try { localStorage.setItem('animationEnabled', 'true'); } catch(e){}
  } else {
    animationEnabled = saved === 'true';
  }
  
  // Apply initial state to body
  if (!animationEnabled) {
    document.body.classList.add('edo-animations-disabled');
  } else {
    document.body.classList.remove('edo-animations-disabled');
  }
  
  updateAnimationButtonUI();

  animationToggleBtn.addEventListener('click', () => {
    animationEnabled = !animationEnabled;
    try { localStorage.setItem('animationEnabled', String(animationEnabled)); } catch(e){}
    
    // Toggle CSS class for Edo animations
    if (animationEnabled) {
      document.body.classList.remove('edo-animations-disabled');
    } else {
      document.body.classList.add('edo-animations-disabled');
    }
    
    updateAnimationButtonUI();
    if (!animationEnabled) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  });

  function updateAnimationButtonUI() {
    animationToggleBtn.classList.toggle('active', animationEnabled);
    const textEl = animationToggleBtn.querySelector('.toggle-text');
    if (textEl) {
      textEl.textContent = animationEnabled ? 'Animation On' : 'Animation Off';
    }
  }
}

// Loading screen handler - ensure it hides properly
(function() {
    function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        const siteContent = document.querySelector('.site-content');
        
        if (!loadingScreen) return; // Already removed or doesn't exist
        
        if (loadingScreen.style.display === 'none') return; // Already hidden
        
        // Add animation to fade out
        loadingScreen.style.opacity = '0';
        loadingScreen.style.transition = 'opacity 0.5s ease';
        
        // Hide after fade animation
        setTimeout(() => {
            if (loadingScreen && loadingScreen.parentNode) {
                loadingScreen.style.display = 'none';
            }
        }, 500);
        
        // Show main content
        if (siteContent) {
            siteContent.style.opacity = '1';
        }
    }
    
    // Hide loading screen after page fully loads
    if (document.readyState === 'complete') {
        // Page already loaded
        setTimeout(hideLoadingScreen, 500);
    } else {
        // Wait for load event
        window.addEventListener('load', hideLoadingScreen, { once: true });
        // Fallback: hide after reasonable timeout
        setTimeout(hideLoadingScreen, 3000);
    }
})();
</script>

<script>
(function(){
  const hdr = document.querySelector('header');
  if (!hdr) return;
  
  let scrollTicking = false;
  let lastScrollY = 0;
  
  const onScroll = () => {
    lastScrollY = window.scrollY;
    
    if (!scrollTicking) {
      window.requestAnimationFrame(() => {
        const scrollThreshold = 30; // pixels before adding 'scrolled' class
        
        if (lastScrollY > scrollThreshold) {
          hdr.classList.add('scrolled');
        } else {
          hdr.classList.remove('scrolled');
        }
        
        scrollTicking = false;
      });
      scrollTicking = true;
    }
  };
  
  // Use passive listener for better scroll performance
  window.addEventListener('scroll', onScroll, { passive: true });
  
  // Check initial state
  setTimeout(() => {
    onScroll();
  }, 100);
})();
</script>


<!-- =============================
     MAIN LEARNING APP SCRIPTS
============================= -->
<script src="authentic-strokes.js"></script>
<script src="FULL_KANA_DATA.js"></script>
<script src="data.js"></script>
<script src="sounds.js"></script>
<script src="js/utils.js"></script>
<script src="js/feedbackSystem.js"></script>
<script src="quiz-toggle.js"></script>
<script src="flashcard-toggle1.js"></script>
<script src="script.js"></script>
<script>
  // Initialize flashcards immediately after scripts load
  try {
    // First initialize Flashcards base object
    if (window.Flashcards && typeof window.Flashcards.init === 'function') {
      window.Flashcards.init();
    }
    
    // Then refresh with toggle data if available
    if (window.Flashcards && window.FlashcardToggle && typeof window.Flashcards.refreshFromToggle === 'function') {
      window.Flashcards.refreshFromToggle();
    }
    
    console.log('Flashcards initialized with', window.Flashcards?.keys?.length || 0, 'characters');
  } catch (e) {
    console.error('Flashcard initialization error:', e);
  }
</script>

<!-- =============================
     WRITING PRACTICE SCRIPTS
============================= -->
<script src="writing-practice.js"></script>

<!-- =============================
     GLOBAL ERROR HANDLER & DIAGNOSTICS
============================= -->
<script>
// Global error handler to catch runtime issues
window.addEventListener('error', function(event) {
    console.error('üî¥ Runtime Error:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
    });
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', function(event) {
    console.error('üî¥ Unhandled Promise Rejection:', event.reason);
});

// Diagnostic check function - runs after everything loads
window.addEventListener('load', function() {
    setTimeout(function() {
        console.log('%cüîç Running Diagnostics...', 'color: #000000; font-weight: bold; font-size: 14px');
        
        const diagnostics = {
            '‚úÖ Data Loaded': {
                'window.Lessons': !!window.Lessons && Array.isArray(window.Lessons),
                'Lessons count': window.Lessons?.length || 0,
                'window.KanaData': !!window.KanaData,
                'window.FULL_KANA_DATA': !!window.FULL_KANA_DATA,
                'window.AuthenticKanaData': !!window.AuthenticKanaData
            },
            '‚úÖ Modules Loaded': {
                'UI': !!window.UI,
                'Progress': !!window.Progress,
                'Flashcards': !!window.Flashcards,
                'Quiz': !!window.Quiz,
                'QuizController': !!window.QuizController,
                'MiniGames': !!window.MiniGames,
                'SRS': !!window.SRS,
                'WritingPractice': !!window.WritingPractice
            },
            '‚úÖ DOM Elements': {
                '#menu': !!document.getElementById('menu'),
                '#curriculum': !!document.getElementById('curriculum'),
                '#flashcards': !!document.getElementById('flashcards'),
                '#quiz': !!document.getElementById('quiz'),
                '#writing': !!document.getElementById('writing'),
                '#game': !!document.getElementById('game'),
                '#minigames': !!document.getElementById('minigames'),
                '#curriculumList': !!document.getElementById('curriculumList')
            },
            '‚úÖ Current State': {
                'Current Section': window.UI?.currentSection || 'unknown',
                'Progress Initialized': !!window.Progress?.state,
                'LocalStorage Available': !!window.localStorage
            }
        };
        
        console.table(diagnostics['‚úÖ Data Loaded']);
        console.table(diagnostics['‚úÖ Modules Loaded']);
        console.table(diagnostics['‚úÖ DOM Elements']);
        console.table(diagnostics['‚úÖ Current State']);
        
        // Check for common issues
        const issues = [];
        if (!window.Lessons || !window.Lessons.length) {
            issues.push('‚ö†Ô∏è WARNING: No lessons data found!');
        }
        if (!window.UI) {
            issues.push('‚ö†Ô∏è WARNING: UI controller not initialized!');
        }
        const currList = document.getElementById('curriculumList');
        if (currList && currList.children.length === 0) {
            issues.push('‚ö†Ô∏è WARNING: Curriculum list is empty! Call Progress.renderCurriculum()');
        }
        
        if (issues.length > 0) {
            console.log('%c‚ö†Ô∏è Issues Detected:', 'color: #000000; font-weight: bold');
            issues.forEach(issue => console.warn(issue));
        } else {
            console.log('%c‚úÖ All Systems Operational', 'color: #000000; font-weight: bold; font-size: 14px');
        }
        
        // Provide helper functions
        console.log('%cüí° Helper Functions Available:', 'color: #000000; font-weight: bold');
        console.log('  ‚Ä¢ window.checkSection("sectionName") - Check if section exists and is visible');
        console.log('  ‚Ä¢ window.forceRenderCurriculum() - Force curriculum to re-render');
        console.log('  ‚Ä¢ window.showDiagnostics() - Re-run this diagnostic check');
        
        // Add helper functions to window
        window.checkSection = function(name) {
            const el = document.getElementById(name);
            if (!el) {
                console.error(`Section "${name}" does not exist in DOM`);
                return false;
            }
            const isHidden = el.classList.contains('hidden');
            console.log(`Section "${name}":`, {
                exists: true,
                visible: !isHidden,
                classList: Array.from(el.classList),
                hasContent: el.children.length > 0
            });
            return !isHidden;
        };
        
        window.forceRenderCurriculum = function() {
            if (window.Progress && typeof window.Progress.renderCurriculum === 'function') {
                console.log('üîÑ Force rendering curriculum...');
                window.Progress.renderCurriculum();
                console.log('‚úÖ Done! Check curriculum section.');
            } else {
                console.error('‚ùå Progress.renderCurriculum not available');
            }
        };
        
        window.showDiagnostics = function() {
            location.reload();
        };
        
    }, 1000); // Wait 1 second after load to ensure all scripts initialized
});
</script>
</body>
</html>
